import streamlit as st
import google.generativeai as genai
import os

# ==========================================
# 1. ุฅุนุฏุงุฏ ุงูุตูุญุฉ
# ==========================================
st.set_page_config(page_title="Diwan Smart Editor", layout="wide", page_icon="๐๏ธ")

# ==========================================
# 2. ุงูุชุตููู
# ==========================================
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap');
    
    .stApp {
        background-color: #008CA0;
        font-family: 'Cairo', sans-serif;
    }
    
    #MainMenu {visibility: hidden;} 
    footer {visibility: hidden;} 
    header {visibility: hidden;}

    .header-container {
        display: flex; justify-content: center; align-items: center;
        margin-bottom: 30px; padding-top: 10px;
    }
    .logo-box {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 10px 40px;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.2);
        color: white; display: flex; align-items: center; gap: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .logo-text-main { font-size: 30px; font-weight: 800; }
    .logo-text-sub { font-size: 13px; opacity: 0.9; letter-spacing: 1px; }
    .orange-box {
        background-color: #D95F18; color: white; font-weight: bold;
        padding: 5px 15px; border-radius: 8px; font-size: 24px;
    }

    div.stButton > button {
        width: 100%; height: 100px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.2);
        font-family: 'Cairo', sans-serif; font-size: 15px; font-weight: 700;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex; flex-direction: column;
        justify-content: center; align-items: center; gap: 8px;
        padding: 10px;
    }

    div.stButton > button[kind="secondary"] {
        background-color: rgba(255, 255, 255, 0.1); color: white;
        backdrop-filter: blur(5px);
    }
    div.stButton > button[kind="secondary"]:hover {
        background-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-5px);
    }

    div.stButton > button[kind="primary"] {
        background-color: #ffffff !important; color: #D95F18 !important;
        border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }
    div.stButton > button p { font-size: 24px; margin-bottom: 5px; }

    .input-card {
        background-color: white; border-radius: 20px;
        padding: 25px; margin-top: 20px; margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .section-label {
        color: #888; font-size: 12px; font-weight: 800;
        margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;
    }
    
    .result-card {
        background-color: #f0f4f9;
        border-radius: 20px;
        padding: 35px;
        margin-top: 20px;
        font-size: 18px; line-height: 2.2; color: #1f1f1f;
        white-space: pre-wrap;
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        border: 1px solid #e0e0e0;
        font-family: 'Cairo', sans-serif;
    }

    @keyframes pulse-orange {
        0% { box-shadow: 0 0 0 0 rgba(217, 95, 24, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(217, 95, 24, 0); }
        100% { box-shadow: 0 0 0 0 rgba(217, 95, 24, 0); }
    }
    
    .stButton button:active {
        animation: pulse-orange 1s;
    }

    .stTextArea textarea {
        background-color: #f8f9fa; border: 1px solid #e0e0e0;
        border-radius: 12px; padding: 15px; font-size: 16px; color: #333;
    }
    .stTextArea textarea:focus { border-color: #D95F18; outline: none; }
    
    [data-testid="column"] { padding: 0 5px; }
</style>
""", unsafe_allow_html=True)

# ==========================================
# 3. ุงูุงุชุตุงู ูุงูููุฏูู
# ==========================================

def setup_api():
    """ุฅุนุฏุงุฏ API ูุน ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก"""
    try:
        if "GEMINI_API_KEY" in st.secrets:
            api_key = st.secrets["GEMINI_API_KEY"]
        elif "GEMINI_API_KEY" in os.environ:
            api_key = os.environ["GEMINI_API_KEY"]
        else:
            st.error("โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ููุชุงุญ API. ูุฑุฌู ุฅุถุงูุชู ูู ููู secrets.toml")
            st.stop()
        
        if not api_key or not api_key.startswith("AIza"):
            st.error("โ๏ธ ููุชุงุญ API ุบูุฑ ุตุญูุญ. ูุฌุจ ุฃู ูุจุฏุฃ ุจู AIza")
            st.stop()
        
        genai.configure(api_key=api_key)
        return True
        
    except Exception as e:
        st.error(f"โ ุฎุทุฃ ูู ุฅุนุฏุงุฏ API: {str(e)}")
        st.stop()
        return False

api_ready = setup_api()

def get_best_model():
    """ุงูุญุตูู ุนูู ุฃูุถู ููุฏูู ูุชุงุญ"""
    try:
        priority_models = [
            'models/gemini-1.5-flash',
            'models/gemini-1.5-pro', 
            'models/gemini-pro'
        ]
        
        available_models = []
        try:
            for m in genai.list_models():
                if 'generateContent' in m.supported_generation_methods:
                    available_models.append(m.name)
        except Exception:
            return 'models/gemini-1.5-flash'
        
        for priority in priority_models:
            if priority in available_models:
                return priority
        
        if available_models:
            return available_models[0]
        else:
            return 'models/gemini-1.5-flash'
            
    except Exception:
        return 'models/gemini-1.5-flash'

# ==========================================
# 4. ุงูููุฏุฑ ูุงูุฃุฒุฑุงุฑ
# ==========================================
st.markdown("""
<div class="header-container">
    <div class="logo-box">
        <div class="orange-box">D</div>
        <div>
            <div class="logo-text-main">ุฏููุงู ุฃู ุฃู</div>
            <div class="logo-text-sub">SMART NEWSROOM EDITOR</div>
        </div>
    </div>
</div>
""", unsafe_allow_html=True)

if 'page' not in st.session_state: 
    st.session_state.page = 'article'

def set_page(p): 
    st.session_state.page = p

buttons_data = [
    {"id": "event", "label": "ุญุฏุซ ูู ูุซู\nูุฐุง ุงูููู", "icon": "๐"},
    {"id": "quotes", "label": "ุฃูู ุงูุชุตุฑูุญุงุช", "icon": "๐ฌ"},
    {"id": "flash", "label": "ููุฌุฒ ุฅุฐุงุนู", "icon": "๐ป"},
    {"id": "audio", "label": "ูู ุตูุช ููุต", "icon": "๐๏ธ"},
    {"id": "titles", "label": "ุตุงูุน ุงูุนูุงููู", "icon": "T"},
    {"id": "article", "label": "ุตูุงุบุฉ ุงูููุงู", "icon": "๐"},
]

cols = st.columns(len(buttons_data))
for i, btn in enumerate(buttons_data):
    with cols[i]:
        active = (st.session_state.page == btn['id'])
        if st.button(f"{btn['icon']}\n{btn['label']}", key=btn['id'], 
                     type="primary" if active else "secondary", use_container_width=True):
            set_page(btn['id'])
            st.rerun()

# ==========================================
# 5. ุงูููุงุนุฏ ูุงูุจุฑููุจุช - ุงููุณุฎุฉ ุงูุงุญุชุฑุงููุฉ
# ==========================================

TUNISIAN_RULES = """
ููุงุนุฏ ุงูุชููุณุฉ ุงูุฅูุฒุงููุฉ:
1. ุงูุฃุดูุฑ: ุฌุงูููุ ูููุฑูุ ูุงุฑุณุ ุฃูุฑููุ ูุงูุ ุฌูุงูุ ุฌููููุฉุ ุฃูุชุ ุณุจุชูุจุฑุ ุฃูุชูุจุฑุ ููููุจุฑุ ุฏูุณูุจุฑ
2. ุญุฐู ุงูุฃููุงุจ: ุงูุณูุฏ/ุงูุณูุฏุฉ/ุงููุญุชุฑู - ุงุณุชุฎุฏู ุงูุตูุฉ + ุงูุงุณู ููุท
3. ุงูุนููุฉ: ุชุญููู ููุฏููุงุฑ ุงูุชููุณู
4. ุงูุชูููุน: ุชููุณ - ุฏููุงู ุฃู ุฃู -
5. ุงูุฃุณููุจ: ููุถูุนู ุตุงุฑูุ ูุฑู ููููุจุ ุฏูุฉ ูุทููุฉ
"""

ARTICLE_PROMPT = """
ุฃูุช ูุญุฑุฑ ุฑุฆูุณู ูู ููุงูุฉ ุชููุณ ุฅูุฑูููุง ููุฃูุจุงุก (TAP) ุจุฎุจุฑุฉ 15 ุนุงูุงู ูู ุชุญุฑูุฑ ุงูุจุฑููุงุช ุงูุฅุฎุจุงุฑูุฉ. ูุชุฎุตุต ูู ุตูุงุบุฉ ุงูุฃุฎุจุงุฑ ููู ูุนุงููุฑ ููุงูุงุช ุงูุฃูุจุงุก ุงูุนุงูููุฉ (Reuters, AFP, AP) ูุน ุงูุงูุชุฒุงู ุจุงููููุฉ ุงูุฅุนูุงููุฉ ุงูุชููุณูุฉ.

ุงููููุฉ: ุชุญููู ุงูุจูุงุบ ุฅูู ุจุฑููุฉ ุฅุฎุจุงุฑูุฉ ุงุญุชุฑุงููุฉ

ููุงุนุฏ ุงูุตูุงุบุฉ ุงูุงุญุชุฑุงููุฉ (ุฅูุฒุงููุฉ):

--- ุงููุณู ุงูุฃูู: ุจููุฉ ุงููุฑู ุงูููููุจ ุงูุตุงุฑูุฉ ---

ุงูููุฑุฉ ุงูุงูุชุชุงุญูุฉ (Lead Paragraph) - 30-40 ูููุฉ:
- ุฃุฌุจ ุนูู ุงูุฃุณุฆูุฉ ุงูุณุชุฉ: ููุ ูุงุฐุงุ ูุชูุ ุฃููุ ููุงุฐุงุ ูููุ
- ุถุน ุฃูู ูุนูููุฉ ูู ุฃูู 7 ูููุงุช
- ุงุณุชุฎุฏู ูุนู ููู ููุจุงุดุฑ ูู ุจุฏุงูุฉ ุงูุฌููุฉ
- ูุซุงู: "ุฃุนูู ูุฒูุฑ ุงููุงููุฉ ุณููู ุดุจู ุงูููู ุงูุฎููุณ ุจุชููุณ ุนู..."

ุงูููุฑุฉ ุงูุซุงููุฉ (Supporting Details) - 50-70 ูููุฉ:
- ุฃุถู ุงูุชูุงุตูู ุงูุญูููุฉ ุงููุจุงุดุฑุฉ ููุญุฏุซ ุงูุฑุฆูุณู
- ุงุดุฑุญ ุงูุณูุงู ุงูููุฑู ุฏูู ุฎูููุงุช ุชุงุฑูุฎูุฉ
- ุงุณุชุฎุฏู ุฌูู ูุตูุฑุฉ (12-15 ูููุฉ)

ุงูููุฑุงุช ุงููุงุญูุฉ (Descending Order):
- ุฑุชุจ ุงููุนูููุงุช ูู ุงูุฃูู ููุฃูู ุฃูููุฉ
- ูู ููุฑุฉ = ููุฑุฉ ูุงุญุฏุฉ ูุญุฏุฏุฉ
- ูููู ุญุฐู ุขุฎุฑ ููุฑุฉ ุฏูู ุงูุฅุฎูุงู ุจุงูุฎุจุฑ

--- ุงููุณู ุงูุซุงูู: ุงูุฃุณููุจ ุงููุบูู ุงูุตุญูู ุงูุฏููู ---

ููุงุนุฏ ุงูุฌููุฉ:
1. ุทูู ุงูุฌููุฉ: 12-18 ูููุฉ (ุญุฏ ุฃูุตู 22 ูููุฉ)
2. ุจููุฉ ุงูุฌููุฉ: ูุนู ูุงุถู + ูุงุนู + ุชูููุฉ ูุจุงุดุฑุฉ
3. ุชุฌูุจ ุงูุฌูู ุงูุงุนุชุฑุงุถูุฉ ูุงูุชูุงุตูู ุงูุฌุงูุจูุฉ
4. ุงุณุชุฎุฏู ููุทุฉ ุจุนุฏ ูู ููุฑุฉ - ูุง ููุงุตู ุทูููุฉ

ุงูุฃูุนุงู ุงูุฅุฎุจุงุฑูุฉ ุงููููุฉ (ุงุณุชุฎุฏููุง ุจุฏูุฉ):
- ููุฅุนูุงู: ุฃุนููุ ูุดูุ ุฃูุตุญุ ุฃูุงุท ุงููุซุงู
- ููุชุฃููุฏ: ุฃูุฏุ ุดุฏุฏุ ููููุ ููุช
- ููุชุตุฑูุญ: ูุงูุ ุตุฑุญุ ุฃูุถุญุ ุจูููุ ุฃุดุงุฑ
- ูููุฑุงุฑุงุช: ูุฑุฑุ ุงุนุชูุฏุ ุฃูุฑุ ุตุงุฏู
- ููุฃุญุฏุงุซ: ุดูุฏุ ุนุฑูุ ุณุฌูุ ููุน

ุชุฌูุจ ุจุดุฏุฉ:
- ุงูุฃูุนุงู ุงูุถุนููุฉ: ูุงูุ ุฃุตุจุญุ ูุจุฏูุ ููุนุชูุฏ
- ุงูุตูุงุช ุงููุจุงูุบุฉ: ูุจูุฑ ุฌุฏุงูุ ูุงู ููุบุงูุฉุ ุจุงูุบ ุงูุฃูููุฉ
- ุงูุชุนุงุจูุฑ ุงูุฅูุดุงุฆูุฉ: ูู ุงูุฌุฏูุฑ ุจุงูุฐูุฑุ ููู ูุฐุง ุงูุณูุงูุ ููู ุงููุนููู
- ุงูุญุดู: ูู ุงููุงูุนุ ูู ุญูููุฉ ุงูุฃูุฑุ ุจุทุจูุนุฉ ุงูุญุงู

--- ุงููุณู ุงูุซุงูุซ: ุงููุนุงููุฑ ุงูุตุญููุฉ ุงูุฏูููุฉ ---

1. ุงูุฏูุฉ ุงููุทููุฉ:
- ุงูุฃุฑูุงู: ุงูุชุจูุง ุจุงูุฃุฑูุงู ุฅุฐุง ูุงูุช ุฏูููุฉ (127 ููููู)
- ุงููุณุจ: ุงูุชุจูุง ุฑูููุงู ูุน ุนูุงูุฉ % (23%)
- ุงูุชูุงุฑูุฎ: ููู ุงูุฎููุณ 9 ุฌุงููู 2026
- ุงูุฃุณูุงุก: ุงุฐูุฑูุง ูุงููุฉ ุนูุฏ ุฃูู ูุฑูุฏ + ุงูุตูุฉ ูุจู ุงูุงุณู

2. ูุณุจุฉ ุงููุนูููุงุช:
- ูู ูุนูููุฉ ูุฌุจ ูุณุจุชูุง ููุตุฏุฑูุง
- ุฃูุซูุฉ ุตุญูุญุฉ: "ุญุณุจ ูุง ุฃุนููู ุงููุฒูุฑ..." ุฃู "ููู ุงูุจูุงู ุงูุตุงุฏุฑ ุนู..." ุฃู "ุจุญุณุจ ุงููุตุฏุฑ ุฐุงุชู..."
- ูุง ุชุณุชุฎุฏู ุตูุบุฉ ุงููุฌููู ุฅูุง ููุถุฑูุฑุฉ

3. ุงูููุถูุนูุฉ ุงูุตุงุฑูุฉ:
- ุงููู ุงูููุงุฆุน ููุท - ุตูุฑ ุชูุณูุฑ
- ูุง ุชุถู ูุนูููุงุช ูู ุฎุงุฑุฌ ุงูุจูุงุบ
- ูุง ุชุณุชูุชุฌ ุฃู ุชุญูู ุฃู ุชุนูู
- ุงูุญูุงุฏ ุงููุทูู ูู ุงุฎุชูุงุฑ ุงููููุงุช

--- ุงููุณู ุงูุฑุงุจุน: ุงูุฎุตูุตูุฉ ุงูุชููุณูุฉ (TAP Style) ---

ุงูุชูููู:
ุฌุงูููุ ูููุฑูุ ูุงุฑุณุ ุฃูุฑููุ ูุงูุ ุฌูุงูุ ุฌููููุฉุ ุฃูุชุ ุณุจุชูุจุฑุ ุฃูุชูุจุฑุ ููููุจุฑุ ุฏูุณูุจุฑ

ุงูุฃููุงุจ ูุงูุตูุงุช:
- ุงุญุฐู: ุงูุณูุฏุ ุงูุณูุฏุฉุ ุงููุญุชุฑูุ ุงููุงุถูุ ุตุงุญุจ ุงูุณุนุงุฏุฉ
- ุงุณุชุฎุฏู: ุงูุตูุฉ + ุงูุงุณู ุงููุงูู (ุฑุฆูุณ ุงูุฌูููุฑูุฉ ููุณ ุณุนูุฏ)
- ุนูุฏ ุงูุชูุฑุงุฑ: ุงูุตูุฉ ููุท (ุงูุฑุฆูุณุ ุงููุฒูุฑุ ุงููุณุคูู)

ุงูุนููุฉ:
- ุญูู ุงููุจุงูุบ ุงูุฃุฌูุจูุฉ ููุฏููุงุฑ ุงูุชููุณู
- ูุซุงู: 1000 ููุฑู (ุญูุงูู 3400 ุฏููุงุฑ)

ุงูุชูููุน ุงูุฅูุฒุงูู:
ุงุจุฏุฃ ูู ููุงู ุจู: "ุชููุณ - ุฏููุงู ุฃู ุฃู -"

--- ุงููุณู ุงูุฎุงูุณ: ุงูุชูุณูู ูุงูุฅุฎุฑุงุฌ ---

ุงูุจููุฉ ุงูููุงุฆูุฉ:
- ูุต ูุชุตู ุจุฏูู ุนูุงููู ูุฑุนูุฉ
- ููุฑุงุช ูููุตูุฉ ุจุณุทุฑ ูุงุฑุบ
- ูู ููุฑุฉ 3-5 ุฌูู ูุญุฏ ุฃูุตู
- ูุง ุชุฑูููุ ูุง ููุงุทุ ูุง ููุงุฆู

ุงููุฎุฑุฌุงุช ุงููุทููุจุฉ:

ุฃููุงู: 5 ุนูุงููู ุงุญุชุฑุงููุฉ ุจุฏููุฉ

ุงูุชุจ 5 ุนูุงููู ูุฎุชููุฉ ุงูุชุฑููุจ:

ุงูุนููุงู 1 (ูุจุงุดุฑ): [ูุนู + ูุงุนู + ูุนูููุฉ ุฃุณุงุณูุฉ] - 6-8 ูููุงุช
ูุซุงู: ูุฒูุฑ ุงูุชุฌุงุฑุฉ ูุนูู ุฅุฌุฑุงุกุงุช ุฌุฏูุฏุฉ ูุฏุนู ุงููุณุชููู

ุงูุนููุงู 2 (ุณุคุงูู): [ุณุคุงู ููุฎุต ุงูุฎุจุฑ] - 5-7 ูููุงุช
ูุซุงู: ูู ุชูุฎูุถ ุฃุณุนุงุฑ ุงูููุงุฏ ุงูุฃุณุงุณูุฉ ูุฑูุจุงูุ

ุงูุนููุงู 3 (ุฑููู): [ูุชุถูู ุฑููุงู ุฏูููุงู] - 6-9 ูููุงุช
ูุซุงู: 250 ููููู ุฏููุงุฑ ูุฏุนู ุงููุฏุฑุฉ ุงูุดุฑุงุฆูุฉ ููุชููุณููู

ุงูุนููุงู 4 (ุชุดูููู): [ูุซูุฑ ุงููุถูู ุฏูู ูุจุงูุบุฉ] - 6-8 ูููุงุช
ูุซุงู: ุฅุฌุฑุงุกุงุช ุญููููุฉ ุนุงุฌูุฉ ูููุงุฌูุฉ ุงุฑุชูุงุน ุงูุฃุณุนุงุฑ

ุงูุนููุงู 5 (ุชุตุฑูุญู): [ุงูุชุจุงุณ ูุจุงุดุฑ ุฅู ุฃููู] - 5-9 ูููุงุช
ูุซุงู: ุงููุฒูุฑ: "ุงูุญูููุฉ ููุชุฒูุฉ ุจุญูุงูุฉ ุงููุฏุฑุฉ ุงูุดุฑุงุฆูุฉ"

ุซุงููุงู: ุงูุจุฑููุฉ ุงูุฅุฎุจุงุฑูุฉ ุงููุงููุฉ

ุงูุชูููุน: ุชููุณ - ุฏููุงู ุฃู ุฃู -

[ุงูููุงู ูุงููุงู ูู ููุฑุงุช ูุชูุงุณูุฉ]

ุงูุทูู ุงููุณุชูุฏู: 250-400 ูููุฉ

--- ุฃูุซูุฉ ุชูุถูุญูุฉ ูู TAP ---

ุตุญูุญ (ุฃุณููุจ ุงุญุชุฑุงูู):
"ุฃุนูู ูุฒูุฑ ุงูุฏุงุฎููุฉ ููุงู ุงููููู ุงูููู ุงูุฌูุนุฉ ุจุชููุณ ุนู ุฅุทูุงู ููุธููุฉ ุฑูููุฉ ุฌุฏูุฏุฉ ูุชุจุณูุท ุฅุฌุฑุงุกุงุช ุงุณุชุฎุฑุงุฌ ูุซุงุฆู ุงููููุฉ. ูุฃูุถุญ ุงููุฒูุฑ ูู ุชุตุฑูุญ ุตุญูู ุฃู ุงูููุธููุฉ ุณุชุฏุฎู ุญูุฒ ุงูุชุทุจูู ูุทูุน ูููุฑู ุงูููุจู ูู 24 ูุนุชูุฏูุฉ ููุฑุญูุฉ ุฃููู."

ุฎุทุฃ (ุฃุณููุจ ุถุนูู):
"ูู ุฎุทูุฉ ูููุฉ ูุฅูุฌุงุจูุฉุ ูุงู ุงูุณูุฏ ูุฒูุฑ ุงูุฏุงุฎููุฉ ุงููุญุชุฑู ุจุงูุฅุนูุงู ุนู ููุธููุฉ ุฌุฏูุฏุฉ ุชุนุชุจุฑ ูู ุฃูู ุงูููุธููุงุช ุงูุฑูููุฉ ุงูุชู ุณุชุณูู ูุซูุฑุงู ุนูู ุงูููุงุทููู..."

--- ูุญุธูุฑุงุช ููุงุฆูุฉ ---

- ุฅุถุงูุฉ ูุนูููุงุช ุบูุฑ ูุงุฑุฏุฉ ูู ุงูุจูุงุบ
- ุงูุชูุณูุฑ ุฃู ุงูุชุญููู ุฃู ุฅุจุฏุงุก ุงูุฑุฃู
- ุงุณุชุฎุฏุงู ุนูุงููู ูุฑุนูุฉ ุฏุงุฎู ุงูููุงู
- ุงูุฃุณููุจ ุงูุฃุฏุจู ุฃู ุงูุจูุงุบู
- ุงูุฌูู ุงููุนูุฏุฉ ุฃูุซุฑ ูู 22 ูููุฉ
- ุงูุญุดู ุงููุบูู ูุงูุชูุฑุงุฑ
- ุงููุจุงูุบุฉ ูู ุงูุตูุงุช

ุงูุขูุ ุทุจู ูู ูุง ุณุจู ุจุฏูุฉ ุตุงุฑูุฉ ุนูู ุงูุจูุงุบ ุงูุชุงูู:
"""

# ุจุงูู ุงูุจุฑููุจุชุงุช
prompts = {
    "article": ARTICLE_PROMPT,
    "titles": f"ุงููููุฉ: ุงูุชุฑุงุญ 5 ุนูุงููู ุงุญุชุฑุงููุฉ ูุชููุนุฉ ุนูู ุทุฑููุฉ ููุงูุงุช ุงูุฃูุจุงุก.\n{TUNISIAN_RULES}",
    "flash": f"ุงููููุฉ: ููุฌุฒ ุฅุฎุจุงุฑู ุณุฑูุน ูููุซู (30-40 ูููุฉ) ุนูู ุทุฑููุฉ ุจุฑููุงุช TAP.\n{TUNISIAN_RULES}",
    "quotes": f"ุงููููุฉ: ุงุณุชุฎุฑุงุฌ ูุชูุณูู ุฃูู ุงูุชุตุฑูุญุงุช ูุน ูุณุจุชูุง ูุฃุตุญุงุจูุง.\n{TUNISIAN_RULES}",
    "event": f"ุงููููุฉ: ุงูุจุญุซ ุนู ุงูุณูุงู ุงูุชุงุฑูุฎู ููุฐุง ุงูุญุฏุซ ูุชูุฏููู ุจุฃุณููุจ ุฅุฎุจุงุฑู.\n{TUNISIAN_RULES}",
    "audio": f"ุงููููุฉ: ุชุญุฑูุฑ ุงููุต ุงูููุฑุบ ุตูุชูุงู ูุชุญูููู ูุจุฑููุฉ ุฅุฎุจุงุฑูุฉ ุงุญุชุฑุงููุฉ.\n{TUNISIAN_RULES}"
}

curr_mode = st.session_state.page
curr_prompt = prompts.get(curr_mode, prompts["article"])
curr_label = next((b['label'].replace('\n', ' ') for b in buttons_data if b['id'] == curr_mode), "ุตูุงุบุฉ ุงูููุงู")

# ==========================================
# 6. ููุทูุฉ ุงูุนูู
# ==========================================

st.markdown(f'<div class="input-card">', unsafe_allow_html=True)
st.markdown(f'<div class="section-label">๐ ุงููุต ุงูุฎุงู (INPUT) - {curr_label}</div>', unsafe_allow_html=True)
input_text = st.text_area("input", height=200, label_visibility="collapsed", 
                           placeholder="ุฃุฏุฎู ุงููุต ููุง...")
st.markdown('</div>', unsafe_allow_html=True)

c1, c2, c3 = st.columns([1, 2, 1]) 
with c2:
    process_btn = st.button("โจ ูุนุงูุฌุฉ ููุฑูุฉ โจ", type="primary", use_container_width=True)

if process_btn and input_text:
    
    with st.spinner('โณ ุฌุงุฑู ุชุญููู ุงููุต ูุตูุงุบุชู ุจุฐูุงุก...'):
        try:
            model_name = get_best_model()
            
            cfg = {
                "temperature": 0.7,
                "max_output_tokens": 8192,
                "top_p": 0.95,
                "top_k": 40
            }
            
            model = genai.GenerativeModel(model_name, generation_config=cfg)
            
            full_prompt = f"{curr_prompt}\n\nุงููุต ุงูุฎุงู:\n{input_text}"
            
            st.markdown(f'<div class="section-label" style="margin-top:30px; color:white;">๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ</div>', 
                       unsafe_allow_html=True)
            res_placeholder = st.empty()
            
            full_text = ""
            
            try:
                response = model.generate_content(full_prompt, stream=True)
                
                for chunk in response:
                    if hasattr(chunk, 'text') and chunk.text:
                        full_text += chunk.text
                        res_placeholder.markdown(
                            f'<div class="result-card">{full_text}</div>', 
                            unsafe_allow_html=True
                        )
                        
            except Exception:
                response = model.generate_content(full_prompt, stream=False)
                
                if response and hasattr(response, 'text'):
                    full_text = response.text
                    res_placeholder.markdown(
                        f'<div class="result-card">{full_text}</div>', 
                        unsafe_allow_html=True
                    )
                else:
                    st.error("โ ูู ูุชู ุงูุญุตูู ุนูู ุงุณุชุฌุงุจุฉ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู")
                    
        except Exception as e:
            st.error(f"โ ุญุฏุซ ุฎุทุฃ: {str(e)}")
            
            with st.expander("๐ ุชูุงุตูู ุงูุฎุทุฃ (ูููุทูุฑูู)"):
                st.code(f"""
ููุน ุงูุฎุทุฃ: {type(e).__name__}
ุงูุฑุณุงูุฉ: {str(e)}
ุงูููุฏูู ุงููุณุชุฎุฏู: {model_name if 'model_name' in locals() else 'ุบูุฑ ูุนุฑูู'}
                """)

elif process_btn and not input_text:
    st.warning("โ๏ธ ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุต ุฃููุงู!")

# ==========================================
# 7. ูุนูููุงุช ูู ุงูู sidebar
# ==========================================
with st.sidebar:
    st.markdown("### โน๏ธ ูุนูููุงุช ุงูุชุทุจูู")
    st.info(f"**ุงูููุฏูู ุงููุณุชุฎุฏู:** {get_best_model()}")
    st.success("โ API ูุชุตู ุจูุฌุงุญ" if api_ready else "โ ุฎุทุฃ ูู ุงูุงุชุตุงู")
    
    st.markdown("---")
    st.markdown("### ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู")
    st.markdown("""
    1. ุงุฎุชุฑ ููุน ุงููุนุงูุฌุฉ ูู ุงูุฃุฒุฑุงุฑ ุงูุนูููุฉ
    2. ุฃุฏุฎู ุงููุต ุงูุฎุงู ูู ุงููุฑุจุน
    3. ุงุถุบุท ุนูู "ูุนุงูุฌุฉ ููุฑูุฉ"
    4. ุงูุชุธุฑ ุงููุชูุฌุฉ
    """)
