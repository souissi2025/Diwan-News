import streamlit as st
import google.generativeai as genai

# --- 1. ุฅุนุฏุงุฏ ุงูุตูุญุฉ ูุงูุณุชุงูู ---
st.set_page_config(page_title="Diwan Newsroom Pro", layout="wide", page_icon="๐๏ธ")

st.markdown("""
<style>
    .stButton>button {
        width: 100%; height: 70px; border-radius: 10px;
        font-size: 16px; font-weight: bold; background-color: #f0f2f6; color: #31333F;
        border: 1px solid #d6d6d6;
    }
    .stButton>button:hover { background-color: #ffe0b2; border-color: #ff8c00; color: #ff8c00; }
    h1, h2, h3 { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .stTextArea textarea { font-size: 16px; font-family: 'Courier New', monospace; }
</style>
""", unsafe_allow_html=True)

# --- 2. ุงูุงุชุตุงู ุจุงูููุชุงุญ ---
try:
    api_key = st.secrets["GEMINI_API_KEY"]
    genai.configure(api_key=api_key)
except:
    st.error("โ๏ธ ุงูููุชุงุญ ููููุฏ (GEMINI_API_KEY).")
    st.stop()

# --- 3. ุงูุฏุงูุฉ ุงูุฐููุฉ ูุงุฎุชูุงุฑ ุงูููุฏูู ---
def get_model(temp=0.3):
    # ูุญุงูู ุงุณุชุฎุฏุงู Pro 1.5 ููุฌูุฏุฉ ุงูุนุงููุฉุ ูุฅุฐุง ูุดู ูุณุชุฎุฏู Flash ููุณุฑุนุฉ
    candidates = ["gemini-1.5-pro", "gemini-pro", "gemini-1.5-flash"]
    
    # ูุญุงููุฉ ูุดู ุงูููุฏููุงุช ุงููุชุงุญุฉ
    available = []
    try:
        for m in genai.list_models():
            if 'generateContent' in m.supported_generation_methods:
                available.append(m.name)
    except:
        pass

    chosen = "gemini-1.5-flash" # ุงูุงูุชุฑุงุถู
    if available:
        for c in candidates:
            if any(c in a for a in available):
                chosen = c
                break
    
    return genai.GenerativeModel(chosen, generation_config={"temperature": temp})

# --- 4. ููุฏุณุฉ ุงูุฃูุงูุฑ (Advanced Prompt Engineering) ---
# ูุฐู ูู "ุนูู" ุงูุตุญูู. ุชู ุชุนุฏูููุง ูุชููู ุตุงุฑูุฉ ุฌุฏุงู.

SYS_INSTRUCTIONS = """
ุฃูุช ุฑุฆูุณ ุชุญุฑูุฑ ูู "ุฅุฐุงุนุฉ ุฏููุงู ุฃู ุฃู". ุฏูุฑู ูู ุฅุนุงุฏุฉ ุตูุงุบุฉ ุงููุตูุต ูุชููู ุฃุฎุจุงุฑุงู ุงุญุชุฑุงููุฉ.
ููุงุนุฏ ุตุงุฑูุฉ:
1. ุงูููุถูุนูุฉ ุงููุทููุฉ: ุงุญุฐู ุฃู ุฑุฃู ุดุฎุตู ุฃู ุนุงุทูุฉ.
2. ุงูุจูุงุก: ุงุณุชุฎุฏู "ุงููุฑู ุงูููููุจ" (ุงูุฃูู ูุงูููู).
3. ุงููุบุฉ: ุนุฑุจูุฉ ูุตุญู ุญุฏูุซุฉุ ูููุฉุ ุฎุงููุฉ ูู ุงูุญุดู (ูุซู: ููุง ูุง ุดู ูููุ ุงูุฌุฏูุฑ ุจุงูุฐูุฑ).
4. ุงูุฃููุงุจ: ุงุญุฐู ุนุจุงุฑุงุช ุงูุชูุฎูู (ูุฎุงูุฉุ ูุนุงููุ ุงูุณูุฏ) ูุงูุชูู ุจุงูุตูุฉ ุงููุธูููุฉ ูุงูุงุณู.
5. ุงูุฃุฑูุงู: ุงูุชุจ ุงูุฃุฑูุงู ูู 1 ุฅูู 10 ุจุงูุญุฑููุ ููุง ููู ุจุงูุฃุฑูุงู.
"""

PROMPTS = {
    "article": """
    ุงููููุฉ: ุตูุงุบุฉ ุฎุจุฑ ุฅุฐุงุนู ููุตู (Radio Report).
    - ุงุจุฏุฃ ุจู "Lead" ููู ูุฌูุจ ุนู (ููุ ูุงุฐุงุ ุฃููุ ูุชู).
    - ุงุณุชุฎุฏู ุฌููุงู ูุตูุฑุฉ ููุดูุทุฉ (ูุนู + ูุงุนู).
    - ุงุฏูุฌ ุงูุฎูููุฉ (Context) ูู ุงูููุฑุฉ ุงูุซุงููุฉ.
    - ุงููุจุฑุฉ: ุฑุณููุฉุ ุฅุฎุจุงุฑูุฉุ ุนุงุฌูุฉ.
    - ุงููุฎุฑุฌ: ุนููุงู ุฑุฆูุณู + ุงููุต (ุญูุงูู 150-200 ูููุฉ).
    """,
    
    "web": """
    ุงููููุฉ: ุชุญุฑูุฑ ููุงู ูููููุน ุงูุฅููุชุฑููู (SEO Optimized).
    - ุงูุนููุงู: ูุฌุจ ุฃู ูููู ุฌุฐุงุจุงู (Clicky) ููู ุตุงุฏูุงู.
    - ุงูููููุฉ: ููุฑุงุช ูุตูุฑุฉ ุฌุฏุงู (2-3 ุฃุณุทุฑ).
    - ุงููููุงุช ุงูููุชุงุญูุฉ: ุฑูุฒ ุนูู ุงููููุงุช ุงูุชู ูุจุญุซ ุนููุง ุงูุชููุณููู.
    - ูู ุงูููุงูุฉ: ุงูุชุฑุญ 3 ูุณูู (Hashtags) ูุชุตููู ุงูุฎุจุฑ.
    """,
    
    "flash": """
    ุงููููุฉ: ููุฌุฒ ุฃุฎุจุงุฑ (Flash Info) ูููุฐูุน.
    - ุงูุชุจ ููุณูุน ูุง ูููุฑุงุกุฉ (Write for the ear).
    - ุฌูู ุจุณูุทุฉ ุฌุฏุงู ููุจุงุดุฑุฉ.
    - ุชุฌูุจ ุงูุฌูู ุงููุนุชุฑุถุฉ ุงูุทูููุฉ.
    - ุงูุทูู ุงูุฃูุตู: 40-50 ูููุฉ ููุท.
    """,
    
    "titles": """
    ุงููููุฉ: ุงูุชุฑุงุญ ุนูุงููู ุจุฏููุฉ. ูุฏู 5 ุฎูุงุฑุงุช:
    1. ุนููุงู ููุงุณููู (ูุตูู).
    2. ุนููุงู ุชุณุงุคูู (ูู...).
    3. ุนููุงู "ุงูุชุจุงุณ" (ุฃุจุฑุฒ ุชุตุฑูุญ).
    4. ุนููุงู ูููุช (Catchy) ูููุณุจูู.
    5. ุนููุงู ูุตูุฑ ุฌุฏุงู (ููุนุงุฌู).
    """,
    
    "quotes": """
    ุงููููุฉ: ุงุณุชุฎุฑุงุฌ ูุชูุณูู ุงูุชุตุฑูุญุงุช (Quotes).
    - ุงุณุชุฎุฑุฌ ููุท ุงูููุงู ุงููุจุงุดุฑ ุงููุงุฑุฏ ูู ุงููุต.
    - ุงูุชูุณูู: 
      * [ุงูุงุณู/ุงูุตูุฉ]: "ูุต ุงูุชุตุฑูุญ..."
    - ุฅุฐุง ูุงู ุงููุต ุบูุฑ ูุจุงุดุฑุ ุญููู ููุจุงุดุฑ ุจุฏูุฉ.
    """,
    
    "analysis": """
    ุงููููุฉ: ุชุญููู ูุง ูุฑุงุก ุงูุฎุจุฑ (ุฒุงููุฉ ุชุญููููุฉ).
    - ุงุดุฑุญ ุฏูุงูุงุช ูุฐุง ุงูุฎุจุฑ.
    - ุงุฑุจุทู ุจุณูุงู ุงูุฃุญุฏุงุซ ุงูุณุงุจูุฉ ูู ุชููุณ.
    - ูุง ูู ุงูุชููุนุงุช ุงููุณุชูุจููุฉ ุจูุงุกู ุนูููุ
    - ูุจุฑุฉ: ุชุญููู ุณูุงุณู/ุงูุชุตุงุฏู ุฑุตูู.
    """
}

# --- 5. ุงููุงุฌูุฉ ุงูุฌุงูุจูุฉ (Sidebar) ---
with st.sidebar:
    st.image("https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Diwan_FM_logo.png/180px-Diwan_FM_logo.png", width=100) # ุดุนุงุฑ ุงูุชุฑุงุถู ุฃู ููููู ุฅุฒุงูุชู
    st.header("โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุญุฑุฑ")
    
    # ุงูุชุญูู ูู ุฏุฑุฌุฉ "ุงูุฅุจุฏุงุน"
    creativity = st.slider("ุฏุฑุฌุฉ ุงูุชุตุฑู (Temperature)", 0.0, 1.0, 0.3, help="0: ุฏููู ุฌุฏุงู ูุญุฑูู. 1: ูุจุฏุน ููุบููุฑ ููุตูุงุบุฉ.")
    
    # ุงูุชุญูู ูู ุงูุทูู (ุชุนูููุงุช ุฅุถุงููุฉ)
    length_option = st.radio("ุทูู ุงููุต ุงููุฎุฑุฌ:", ["ุชููุงุฆู", "ูุฎุชุตุฑ ุฌุฏุงู", "ููุตู ููุนูู"])
    length_instruction = ""
    if length_option == "ูุฎุชุตุฑ ุฌุฏุงู": length_instruction = "ุงุฌุนู ุงููุต ูุฎุชุตุฑุงู ุฌุฏุงู ููุฑูุฒุงู."
    elif length_option == "ููุตู ููุนูู": length_instruction = "ุชูุณุน ูู ุงูุชูุงุตูู ูุงูุฎูููุงุช."

# --- 6. ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ ---
st.title("๐๏ธ Diwan Smart Newsroom")

if 'mode' not in st.session_state: st.session_state.mode = "article"
def set_mode(m): st.session_state.mode = m

# ุดุจูุฉ ุงูุฃุฒุฑุงุฑ
col1, col2, col3 = st.columns(3)
with col1:
    if st.button("๐ ุฎุจุฑ ุฅุฐุงุนู (Article)"): set_mode("article")
    if st.button("๐ ุชุญููู (Analysis)"): set_mode("analysis")
with col2:
    if st.button("๐ ููุจ (Web/SEO)"): set_mode("web")
    if st.button("๐ท๏ธ ุนูุงููู (Titles)"): set_mode("titles")
with col3:
    if st.button("โก ููุฌุฒ (Flash)"): set_mode("flash")
    if st.button("๐ฌ ุชุตุฑูุญุงุช (Quotes)"): set_mode("quotes")

st.markdown("---")

# ุนุฑุถ ุงููุถุน ุงูุญุงูู
titles_display = {
    "article": "ุชุญุฑูุฑ ุฎุจุฑ ุฅุฐุงุนู ุฑุฆูุณู",
    "web": "ุชุญุฑูุฑ ูููููุน (SEO)",
    "flash": "ุตูุงุบุฉ ููุฌุฒ (Flash)",
    "titles": "ุชูููุฏ ุนูุงููู",
    "quotes": "ุงุณุชุฎุฑุงุฌ ุงูุชุตุฑูุญุงุช",
    "analysis": "ุชุญููู ูุณูุงู"
}
curr = st.session_state.mode
st.subheader(f"๐ ุงููุถุน ุงูุญุงูู: {titles_display[curr]}")

# ูููุฐุฌ ุงูุฅุฏุฎุงู
with st.form("editor_form"):
    text_input = st.text_area("ุฃุฏุฎู ุงููุต ุงูุฎุงูุ ุงูุจูุงูุ ุฃู ุฑุคูุณ ุงูุฃููุงู:", height=250)
    
    c1, c2 = st.columns([1, 4])
    with c1:
        submitted = st.form_submit_button("๐ ูุนุงูุฌุฉ ุงููุต")
    
    if submitted and text_input:
        with st.spinner('ุฌุงุฑู ุงูุชุญุฑูุฑ ุงูุฐูู...'):
            try:
                # 1. ุชุฌููุฒ "ุงูุจุฑููุจุช" ุงููุงูู
                full_prompt = f"""
                {SYS_INSTRUCTIONS}
                
                {PROMPTS[curr]}
                
                ุชุนูููุงุช ุฅุถุงููุฉ: {length_instruction}
                
                ุงููุต ุงููุฑุงุฏ ูุนุงูุฌุชู:
                {text_input}
                """
                
                # 2. ุงุณุชุฏุนุงุก ุงูููุฏูู (ูุน ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ุงููุฎุชุงุฑุฉ)
                model = get_model(temp=creativity)
                response = model.generate_content(full_prompt)
                
                # 3. ุงูุนุฑุถ
                st.success("โ ุชู ุงูุชุญุฑูุฑ:")
                st.markdown(response.text)
                
                # ุฅุธูุงุฑ ุงูููุฏูู ุงููุณุชุฎุฏู ูููุฑุงูุจุฉ ุงูุชูููุฉ
                st.caption(f"ุงููุญุฑู ุงููุณุชุฎุฏู: {model.model_name}")
                
            except Exception as e:
                st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ: {e}")
